version: "3.8"

services:
  postgres:
    image: postgres:16-alpine
    container_name: qreate-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./apps/api/sql:/docker-entrypoint-initdb.d

  redis:
    image: redis:7-alpine
    container_name: qreate-redis
    restart: unless-stopped
    ports:
      - "6379:6379"

  api:
    container_name: qreate-api
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./docker/api.Dockerfile
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - redis
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME}
      - APP_ENV=${APP_ENV}
      - APP_PORT=${APP_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_SSLMODE=${DATABASE_SSLMODE}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_TTL_SECONDS=${JWT_ACCESS_TOKEN_TTL_SECONDS}
      - JWT_REFRESH_TOKEN_TTL_SECONDS=${JWT_REFRESH_TOKEN_TTL_SECONDS}
      - QR_BASE_URL=${QR_BASE_URL}
      - QR_SHORT_CODE_LENGTH=${QR_SHORT_CODE_LENGTH}

  backoffice:
    container_name: qreate-backoffice
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./docker/backoffice.Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    ports:
      - "3000:8080"
    environment:
      - NODE_ENV=production
      - PORT=8080
      - HOSTNAME=0.0.0.0

  webapp:
    container_name: qreate-webapp
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./docker/webapp.Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    ports:
      - "3001:8080"
    environment:
      - NODE_ENV=production
      - PORT=8080
      - HOSTNAME=0.0.0.0

volumes:
  postgres_data:

networks:
  default:
    name: qreate-network
